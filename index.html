<!-- <!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FHS Chat Widget</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: transparent;
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: system-ui, Arial;
    }

    /* This wrapper fills the entire iframe area */
    .wrap {
      position: relative;
      width: 100vw;
      height: 100vh;
      background: transparent;
    }

    /* Chat bubble button (always visible) */
    #bubble {
      position: absolute;
      right: 14px;
      bottom: 14px;
      width: 56px;
      height: 56px;
      border-radius: 999px;
      border: 2px solid #1a73e8;
      background: #fff;
      cursor: pointer;
      display: grid;
      place-items: center;
      font-size: 14px;
      line-height: 1;
      user-select: none;
    }

    /* Chat panel popup (hidden until bubble click) */
    #panel {
      position: absolute;
      right: 14px;
      bottom: 82px;
      width: 360px;
      height: 480px;
      border: 1px solid #222;
      border-radius: 12px;
      background: #fff;
      display: none;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
    }

    /* Header */
    #top {
      padding: 10px 12px;
      border-bottom: 1px solid #eee;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    #close {
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      padding: 2px 6px;
    }

    /* Messages */
    #msgs {
      height: calc(480px - 48px - 56px);
      overflow: auto;
      padding: 10px 12px;
      font-size: 14px;
    }

    .m { margin: 10px 0; }
    .who { font-weight: 700; }
    .bubble-text { white-space: pre-wrap; }

    /* Input row */
    #box {
      display: flex;
      gap: 8px;
      padding: 10px 12px;
      border-top: 1px solid #eee;
      height: 56px;
      box-sizing: border-box;
      align-items: center;
    }

    #in {
      flex: 1;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 10px;
      outline: none;
    }

    #send {
      padding: 10px 12px;
      border: 1px solid #222;
      background: #fff;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
    }

    /* Mobile: make panel nearly full width */
    @media (max-width: 480px) {
      #panel {
        width: calc(100vw - 28px);
        height: 70vh;
      }
      #msgs {
        height: calc(70vh - 48px - 56px);
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <button id="bubble" aria-label="Open chat">Chat</button>

    <div id="panel" role="dialog" aria-label="Chat panel">
      <div id="top">
        <div>Future Histories Studio</div>
        <button id="close" aria-label="Close chat">×</button>
      </div>

      <div id="msgs"></div>

      <div id="box">
        <input id="in" placeholder="Ask a question..." />
        <button id="send">Send</button>
      </div>
    </div>
  </div>

  <script>
    // Your Render backend endpoint
    const API_URL = "https://fhs-chatbot.onrender.com/chat";

    const bubble = document.getElementById("bubble");
    const panel  = document.getElementById("panel");
    const close  = document.getElementById("close");
    const msgs   = document.getElementById("msgs");
    const inp    = document.getElementById("in");
    const send   = document.getElementById("send");

    let greeted = false;

    function escapeHtml(s) {
      return s.replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    function addMsg(who, text) {
      const div = document.createElement("div");
      div.className = "m";
      div.innerHTML = `<div class="who">${who}</div><div class="bubble-text">${escapeHtml(text)}</div>`;
      msgs.appendChild(div);
      msgs.scrollTop = msgs.scrollHeight;
      return div;
    }

    function openPanel() {
      panel.style.display = "block";
      if (!greeted) {
        greeted = true;
        addMsg("Bot", "Hi. Ask me anything based on the provided documents.");
      }
      setTimeout(() => inp.focus(), 50);
    }

    function closePanel() {
      panel.style.display = "none";
    }

    bubble.onclick = () => {
      if (panel.style.display === "block") closePanel();
      else openPanel();
    };

    close.onclick = closePanel;

    async function ask() {
      const q = (inp.value || "").trim();
      if (!q) return;

      inp.value = "";
      addMsg("You", q);
      const thinking = addMsg("Bot", "Thinking...");

      try {
        const r = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: q })
        });

        const j = await r.json();
        thinking.remove();

        const ans = (j && j.answer) ? j.answer : "I do not have that information in the provided materials.";
        addMsg("Bot", ans);
      } catch (e) {
        thinking.remove();
        addMsg("Bot", "Chat is unavailable right now.");
      }
    }

    send.onclick = ask;
    inp.addEventListener("keydown", (e) => {
      if (e.key === "Enter") ask();
      if (e.key === "Escape") closePanel();
    });

    // Optional: if you want the chat panel to open automatically after a short delay
    // setTimeout(openPanel, 2000);
  </script>
</body>
</html> -->

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FHS Chat Widget</title>
  <style>
    :root{
      --bg:#0b0b0f;
      --panel:#12121a;
      --panel2:#0f0f16;
      --text:#f3f3f6;
      --muted:#b7b7c3;
      --border:rgba(255,255,255,.12);
      --shadow:0 18px 50px rgba(0,0,0,.45);
      --accent:#7c5cff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:transparent}

    /* Floating launcher */
    #fhs-launcher{
      position:fixed;
      right:18px;
      bottom:18px;
      width:54px;
      height:54px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
      box-shadow:var(--shadow);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
      z-index:999999;
    }
    #fhs-launcher:hover{transform:translateY(-1px)}
    #fhs-launcher:active{transform:translateY(0px)}
    #fhs-launcher svg{width:22px;height:22px}
    #fhs-badge{
      position:absolute;
      top:-6px;
      right:-6px;
      width:18px;
      height:18px;
      border-radius:999px;
      background:var(--accent);
      border:2px solid var(--bg);
      display:none;
    }

    /* Chat panel */
    #fhs-panel{
      position:fixed;
      right:18px;
      bottom:84px;
      width:min(380px, calc(100vw - 36px));
      height:min(560px, calc(100vh - 120px));
      border-radius:16px;
      border:1px solid var(--border);
      background:var(--panel);
      color:var(--text);
      box-shadow:var(--shadow);
      overflow:hidden;
      display:none;
      z-index:999999;
    }
    #fhs-header{
      height:52px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 12px 0 14px;
      gap:10px;
    }
    #fhs-title{
      display:flex;
      flex-direction:column;
      line-height:1.1;
      gap:2px;
      min-width:0;
    }
    #fhs-title strong{font-size:14px;letter-spacing:.2px}
    #fhs-title span{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    #fhs-actions{display:flex;gap:8px;align-items:center}
    .fhs-iconbtn{
      width:34px;height:34px;border-radius:10px;
      border:1px solid var(--border);
      background:transparent;color:var(--text);
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;
    }
    .fhs-iconbtn:hover{background:rgba(255,255,255,.06)}
    .fhs-iconbtn svg{width:18px;height:18px}

    /* Messages */
    #fhs-messages{
      height:calc(100% - 52px - 70px);
      overflow:auto;
      padding:14px 14px 10px 14px;
      background:var(--panel2);
    }
    .msg{
      max-width:92%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      margin:0 0 10px 0;
      white-space:pre-wrap;
      font-size:14px;
      line-height:1.35;
    }
    .msg.user{
      margin-left:auto;
      background:rgba(124,92,255,.16);
      border-color:rgba(124,92,255,.30);
    }
    .msg.bot{
      margin-right:auto;
      background:rgba(255,255,255,.04);
    }
    .meta{
      font-size:12px;
      color:var(--muted);
      margin:6px 0 10px 2px;
    }
    .typing{
      display:inline-flex;gap:4px;align-items:center
    }
    .dot{
      width:6px;height:6px;border-radius:50%;
      background:rgba(243,243,246,.75);
      animation:blink 1.1s infinite ease-in-out;
    }
    .dot:nth-child(2){animation-delay:.15s}
    .dot:nth-child(3){animation-delay:.3s}
    @keyframes blink{
      0%,100%{opacity:.25;transform:translateY(0)}
      50%{opacity:1;transform:translateY(-1px)}
    }

    /* Composer */
    #fhs-composer{
      height:70px;
      border-top:1px solid var(--border);
      background:var(--panel);
      padding:10px;
      display:flex;
      gap:10px;
      align-items:flex-end;
    }
    #fhs-input{
      flex:1;
      resize:none;
      height:48px;
      max-height:120px;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      outline:none;
      font-size:14px;
      line-height:1.25;
    }
    #fhs-input::placeholder{color:rgba(183,183,195,.75)}
    #fhs-send{
      width:48px;height:48px;
      border-radius:12px;
      border:1px solid rgba(124,92,255,.45);
      background:rgba(124,92,255,.18);
      color:var(--text);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #fhs-send:hover{background:rgba(124,92,255,.26)}
    #fhs-send:disabled{
      opacity:.55;cursor:not-allowed;
    }
    #fhs-send svg{width:18px;height:18px}

    /* Small screens */
    @media (max-width: 420px){
      #fhs-panel{right:10px;left:10px;width:auto}
      #fhs-launcher{right:14px;bottom:14px}
    }
  </style>
</head>
<body>

  <!-- Launcher -->
  <button id="fhs-launcher" aria-label="Open chat">
    <span id="fhs-badge"></span>
    <!-- chat icon -->
    <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M20 12c0 3.866-3.582 7-8 7a9.3 9.3 0 0 1-3.2-.56L4 20l1.25-3.2A6.75 6.75 0 0 1 4 12c0-3.866 3.582-7 8-7s8 3.134 8 7Z" stroke="currentColor" stroke-width="1.7" stroke-linejoin="round"/>
      <path d="M8 12h8" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
      <path d="M8 9h5" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
    </svg>
  </button>

  <!-- Panel -->
  <section id="fhs-panel" role="dialog" aria-label="FHS chat">
    <header id="fhs-header">
      <div id="fhs-title">
        <strong>FHS Assistant</strong>
        <span>Ask about the studio, people, events, and resources</span>
      </div>
      <div id="fhs-actions">
        <button class="fhs-iconbtn" id="fhs-mute" aria-label="Toggle voice">
          <!-- speaker icon -->
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M11 5 7.5 8H5a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h2.5L11 19V5Z" stroke="currentColor" stroke-width="1.7" stroke-linejoin="round"/>
            <path d="M15.5 9.5a3.5 3.5 0 0 1 0 5" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
            <path d="M17.8 7.2a6.5 6.5 0 0 1 0 9.2" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
          </svg>
        </button>
        <button class="fhs-iconbtn" id="fhs-close" aria-label="Close chat">
          <!-- X icon -->
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M7 7l10 10M17 7 7 17" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
    </header>

    <div id="fhs-messages">
      <div class="msg bot">Hi. I’m the FHS Assistant. What would you like to know?</div>
      <div class="meta">Tip: Ask about people, events, resources, or how to connect.</div>
    </div>

    <div id="fhs-composer">
      <textarea id="fhs-input" placeholder="Type your question..." rows="1"></textarea>
      <button id="fhs-send" aria-label="Send">
        <!-- send icon -->
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M4 12 20 4l-4 16-5-7-7-1Z" stroke="currentColor" stroke-width="1.7" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  </section>

  <audio id="fhs-audio" preload="none"></audio>

  <script>
    // ----------------------------
    // CONFIG: Set this to your deployed backend
    // Example: https://your-service.onrender.com
    // ----------------------------
    const BACKEND_BASE_URL = "http://127.0.0.1:5050";

    const launcher = document.getElementById("fhs-launcher");
    const panel = document.getElementById("fhs-panel");
    const closeBtn = document.getElementById("fhs-close");
    const muteBtn = document.getElementById("fhs-mute");
    const badge = document.getElementById("fhs-badge");

    const messages = document.getElementById("fhs-messages");
    const input = document.getElementById("fhs-input");
    const sendBtn = document.getElementById("fhs-send");
    const audioEl = document.getElementById("fhs-audio");

    let isOpen = false;
    let voiceEnabled = true;

    function openChat() {
      panel.style.display = "block";
      badge.style.display = "none";
      isOpen = true;
      setTimeout(() => input.focus(), 0);
    }

    function closeChat() {
      panel.style.display = "none";
      isOpen = false;
    }

    launcher.addEventListener("click", () => {
      if (isOpen) closeChat();
      else openChat();
    });

    closeBtn.addEventListener("click", closeChat);

    muteBtn.addEventListener("click", () => {
      voiceEnabled = !voiceEnabled;
      // quick visual feedback by lowering opacity when muted
      muteBtn.style.opacity = voiceEnabled ? "1" : "0.55";
      // stop current audio if any
      if (!voiceEnabled) {
        audioEl.pause();
        audioEl.currentTime = 0;
      }
    });

    function scrollToBottom() {
      messages.scrollTop = messages.scrollHeight;
    }

    function addMessage(text, who) {
      const div = document.createElement("div");
      div.className = "msg " + who;
      div.textContent = text;
      messages.appendChild(div);
      scrollToBottom();
      return div;
    }

    function addTyping() {
      const div = document.createElement("div");
      div.className = "msg bot";
      div.innerHTML = '<span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>';
      messages.appendChild(div);
      scrollToBottom();
      return div;
    }

    function normalizeBackendUrl() {
      let u = (BACKEND_BASE_URL || "").trim();
      if (!u) return "";
      // remove trailing slash
      if (u.endsWith("/")) u = u.slice(0, -1);
      return u;
    }

    async function sendMessage() {
      const q = input.value.trim();
      if (!q) return;

      addMessage(q, "user");
      input.value = "";
      input.style.height = "48px";

      sendBtn.disabled = true;
      const typingEl = addTyping();

      const base = normalizeBackendUrl();
      if (!base) {
        typingEl.remove();
        addMessage("Backend URL is not set. Update BACKEND_BASE_URL in index.html.", "bot");
        sendBtn.disabled = false;
        return;
      }

      try {
        const resp = await fetch(base + "/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: q, voice: voiceEnabled })
        });

        const data = await resp.json();

        typingEl.remove();

        const answer = (data.answer || "").trim() || "I don’t have that information in the provided materials.";
        addMessage(answer, "bot");

        const audioUrl = (data.audio_url || "").trim();
        if (voiceEnabled && audioUrl) {
          // audio_url is absolute in our backend, but handle relative just in case
          const finalUrl = audioUrl.startsWith("http") ? audioUrl : (base + audioUrl);
          audioEl.src = finalUrl;
          try { await audioEl.play(); } catch(e) {}
        }

        if (!isOpen) badge.style.display = "block";

      } catch (e) {
        typingEl.remove();
        addMessage("Something went wrong. Please try again.", "bot");
      } finally {
        sendBtn.disabled = false;
        input.focus();
      }
    }

    sendBtn.addEventListener("click", sendMessage);

    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Autosize textarea
    input.addEventListener("input", () => {
      input.style.height = "48px";
      input.style.height = Math.min(input.scrollHeight, 120) + "px";
    });

    // Close panel on ESC
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && isOpen) closeChat();
    });
  </script>
</body>
</html>
